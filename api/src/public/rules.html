<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Regras NLQ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 24px;
        background: #f4f6f9;
        color: #1f2933;
      }
      h1,
      h2 {
        margin-top: 0;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      }
      label {
        display: block;
        font-weight: 600;
        margin: 12px 0 4px;
      }
      input[type="text"],
      input[type="password"],
      textarea,
      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        font-size: 14px;
        transition: border 0.2s ease;
        box-sizing: border-box;
      }
      input[type="text"]:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
      }
      textarea {
        min-height: 120px;
        resize: vertical;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
      }
      .row > div {
        flex: 1 1 240px;
      }
      button {
        background: #2563eb;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease;
        margin-right: 8px;
        margin-top: 12px;
      }
      button.secondary {
        background: #334155;
      }
      button.danger {
        background: #dc2626;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 12px;
        border-bottom: 1px solid #e2e8f0;
        text-align: left;
        vertical-align: top;
      }
      th {
        background: #f8fafc;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .status {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        text-transform: uppercase;
      }
      .status.active {
        background: #dcfce7;
        color: #166534;
      }
      .status.inactive {
        background: #fee2e2;
        color: #991b1b;
      }
      pre {
        white-space: pre-wrap;
        word-break: break-word;
        background: #0f172a;
        color: #e2e8f0;
        padding: 12px;
        border-radius: 8px;
        font-size: 13px;
        max-height: 180px;
        overflow: auto;
      }
      .message {
        padding: 12px 16px;
        border-radius: 8px;
        margin-top: 12px;
        display: none;
      }
      .message.success {
        background: #dcfce7;
        color: #166534;
        display: block;
      }
      .message.error {
        background: #fee2e2;
        color: #991b1b;
        display: block;
      }
      .actions button {
        margin-top: 4px;
        width: 100%;
      }
      @media (max-width: 768px) {
        table,
        thead,
        tbody,
        th,
        td,
        tr {
          display: block;
        }
        th {
          position: sticky;
          top: 0;
        }
        tr {
          margin-bottom: 16px;
          background: #fff;
          border-radius: 12px;
          padding: 12px;
          box-shadow: 0 4px 10px rgba(15, 23, 42, 0.06);
        }
        td {
          border: none;
          padding: 8px 0;
        }
        td::before {
          content: attr(data-label);
          font-weight: 600;
          display: block;
          margin-bottom: 4px;
          color: #475569;
        }
        .actions button {
          width: auto;
          margin-right: 6px;
        }
      }
    </style>
  </head>
  <body>
    <h1>Central de Regras NLQ</h1>
    <div class="card">
      <h2>1. Autenticação</h2>
      <label for="token">Token JWT</label>
      <input
        id="token"
        type="text"
        placeholder="cole aqui o token gerado pelo /auth/login"
      />
      <div class="row">
        <div>
          <label for="companyId">Empresa (opcional)</label>
          <input
            id="companyId"
            type="text"
            placeholder="usa a empresa do token se vazio"
          />
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="loadRules">Carregar regras</button>
        </div>
      </div>
      <div id="authMessage" class="message"></div>
    </div>

    <div class="card">
      <h2>2. Criar nova regra</h2>
      <form id="createForm">
        <div class="row">
          <div>
            <label for="ruleName">Nome</label>
            <input id="ruleName" type="text" required />
          </div>
          <div>
            <label for="ruleType">Tipo</label>
            <select id="ruleType">
              <option value="schedule_report">Relatório agendado</option>
              <option value="threshold_alert">Alerta contínuo</option>
            </select>
          </div>
          <div id="cronWrapper">
            <label for="ruleCron">Cron (UTC)</label>
            <input id="ruleCron" type="text" placeholder="ex.: 0 8 * * *" />
          </div>
          <div>
            <label for="activateToggle">Ativar imediatamente?</label>
            <select id="activateToggle">
              <option value="yes">Sim</option>
              <option value="no" selected>Não</option>
            </select>
          </div>
        </div>

        <label for="rulePrompt">Prompt (texto em linguagem natural)</label>
        <textarea
          id="rulePrompt"
          placeholder="Ex.: Top 10 dispositivos por consumo no último dia"
        ></textarea>

        <label for="ruleMetadata">Metadata (JSON opcional)</label>
        <textarea
          id="ruleMetadata"
          placeholder='{"sqlParams": ["$COMPANY_ID"]}'
        ></textarea>

        <button type="submit">Salvar regra</button>
      </form>
      <div id="createMessage" class="message"></div>
    </div>

    <div class="card">
      <h2>3. Regras cadastradas</h2>
      <div id="rulesMessage" class="message"></div>
      <div class="table-wrapper">
        <table id="rulesTable">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Tipo</th>
              <th>Status</th>
              <th>Cron / Última execução</th>
              <th>Prompt</th>
              <th>Último resultado</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <script>
      const tokenInput = document.getElementById("token");
      const companyInput = document.getElementById("companyId");
      const loadBtn = document.getElementById("loadRules");
      const authMessage = document.getElementById("authMessage");
      const createForm = document.getElementById("createForm");
      const createMessage = document.getElementById("createMessage");
      const rulesMessage = document.getElementById("rulesMessage");
      const rulesTableBody = document.querySelector("#rulesTable tbody");
      const typeSelect = document.getElementById("ruleType");
      const cronWrapper = document.getElementById("cronWrapper");
      const scheduleInput = document.getElementById("ruleScheduleText");

      let cachedRules = [];

      function setMessage(el, message, type = "success") {
        if (!message) {
          el.style.display = "none";
          el.textContent = "";
          el.className = "message";
          return;
        }
        el.textContent = message;
        el.className = `message ${type}`;
      }

      function getAuthHeaders() {
        const token = tokenInput.value.trim();
        if (!token) {
          throw new Error("Informe o token JWT.");
        }
        return {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        };
      }

      async function fetchJson(url, options = {}) {
        const response = await fetch(url, options);
        if (!response.ok) {
          const text = await response.text();
          throw new Error(text || response.statusText);
        }
        if (response.status === 204) return null;
        return response.json();
      }

      function renderRules(list) {
        cachedRules = list;
        rulesTableBody.innerHTML = "";
        if (!Array.isArray(list) || list.length === 0) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 7;
          cell.textContent = "Nenhuma regra cadastrada ainda.";
          cell.style.textAlign = "center";
          row.appendChild(cell);
          rulesTableBody.appendChild(row);
          return;
        }

        for (const rule of list) {
          const tr = document.createElement("tr");

          tr.innerHTML = `
          <td data-label="Nome">
            <strong>${rule.name}</strong><br />
            <small>${rule.companyId}</small>
          </td>
          <td data-label="Tipo">${rule.type}</td>
          <td data-label="Status"><span class="status ${rule.status}">${
            rule.status
          }</span></td>
          <td data-label="Agendamento">
            ${rule.scheduleCron || "-"}<br />
            <small>${
              rule.scheduleSummary || rule.metadata?.scheduleSummary || ""
            }</small><br />
            <small>${
              rule.scheduleText || rule.metadata?.scheduleText || ""
            }</small><br />
            <small>last run: ${rule.lastRunAt || "-"}</small>
          </td>
          <td data-label="Prompt"><pre>${rule.prompt || ""}</pre></td>
          <td data-label="Resultado">
            ${
              rule.lastResult
                ? `<pre>${JSON.stringify(rule.lastResult, null, 2)}</pre>`
                : "-"
            }
          </td>
          <td data-label="Ações" class="actions"></td>
        `;

          const actionsCell = tr.querySelector(".actions");

          const activateBtn = document.createElement("button");
          activateBtn.textContent =
            rule.status === "active" ? "Desativar" : "Ativar";
          activateBtn.className = rule.status === "active" ? "secondary" : "";
          activateBtn.addEventListener("click", () => toggleRule(rule));

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "Excluir";
          deleteBtn.className = "danger";
          deleteBtn.addEventListener("click", () => deleteRule(rule));

          actionsCell.appendChild(activateBtn);
          actionsCell.appendChild(deleteBtn);

          rulesTableBody.appendChild(tr);
        }
      }

      async function loadRules() {
        setMessage(authMessage);
        setMessage(rulesMessage);
        try {
          const headers = getAuthHeaders();
          const companyId = companyInput.value.trim();
          const query = new URLSearchParams();
          if (companyId) query.set("companyId", companyId);
          const data = await fetchJson(`/rules?${query.toString()}`, {
            headers,
          });
          renderRules(data?.items ?? []);
          setMessage(authMessage, "Regras carregadas com sucesso!", "success");
        } catch (err) {
          setMessage(authMessage, err.message, "error");
        }
      }

      async function toggleRule(rule) {
        try {
          const headers = getAuthHeaders();
          const endpoint = rule.status === "active" ? "deactivate" : "activate";
          await fetchJson(`/rules/${rule.id}/${endpoint}`, {
            method: "POST",
            headers,
          });
          await loadRules();
        } catch (err) {
          setMessage(rulesMessage, err.message, "error");
        }
      }

      async function deleteRule(rule) {
        if (!confirm(`Excluir a regra "${rule.name}"?`)) return;
        try {
          const headers = getAuthHeaders();
          await fetchJson(`/rules/${rule.id}`, { method: "DELETE", headers });
          await loadRules();
        } catch (err) {
          setMessage(rulesMessage, err.message, "error");
        }
      }

      createForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        setMessage(createMessage);
        try {
          const headers = getAuthHeaders();
          const name = document.getElementById("ruleName").value.trim();
          const type = typeSelect.value;
          const prompt = document.getElementById("rulePrompt").value.trim();
          const scheduleText = scheduleInput.value.trim();
          const activate =
            document.getElementById("activateToggle").value === "yes";
          const bodyCompanyId = companyInput.value.trim() || undefined;
          let metadata = {};
          const metadataRaw = document
            .getElementById("ruleMetadata")
            .value.trim();
          if (metadataRaw) {
            try {
              metadata = JSON.parse(metadataRaw);
            } catch (err) {
              throw new Error("Metadata precisa ser um JSON válido.");
            }
          }

          const payload = {
            name,
            type,
            prompt,
            metadata,
            activate,
            companyId: bodyCompanyId,
          };

          if (type === "schedule_report") {
            if (!scheduleCron) {
              throw new Error("Informe o cron para relatórios agendados.");
            }
            payload.scheduleCron = scheduleCron;
          }
          console.log(JSON.stringify(payload));

          await fetchJson("/rules", {
            method: "POST",
            headers,
            body: JSON.stringify(payload),
          });

          setMessage(createMessage, "Regra criada com sucesso!", "success");
          createForm.reset();
          typeSelect.dispatchEvent(new Event("change"));
          await loadRules();
        } catch (err) {
          setMessage(createMessage, err.message, "error");
        }
      });

      loadBtn.addEventListener("click", () => {
        loadRules();
      });

      typeSelect.addEventListener("change", () => {
        const value = typeSelect.value;
        cronWrapper.style.display =
          value === "schedule_report" ? "block" : "none";
        if (value !== "schedule_report") {
          scheduleInput.value = "";
        }
      });

      typeSelect.dispatchEvent(new Event("change"));
    </script>
  </body>
</html>
