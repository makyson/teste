<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <title>Regras NLQ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 24px;
        background: #f4f6f9;
        color: #1f2933;
      }
      h1,
      h2 {
        margin-top: 0;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      }
      label {
        display: block;
        font-weight: 600;
        margin: 12px 0 4px;
      }
      input[type="text"],
      input[type="password"],
      textarea,
      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        font-size: 14px;
        transition: border 0.2s ease;
        box-sizing: border-box;
      }
      input[type="text"]:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
      }
      textarea {
        min-height: 120px;
        resize: vertical;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
      }
      .row > div {
        flex: 1 1 240px;
      }
      button {
        background: #2563eb;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 10px 18px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease;
        margin-right: 8px;
        margin-top: 12px;
      }
      button.secondary {
        background: #334155;
      }
      button.danger {
        background: #dc2626;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 12px;
        border-bottom: 1px solid #e2e8f0;
        text-align: left;
        vertical-align: top;
      }
      th {
        background: #f8fafc;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .status {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        text-transform: uppercase;
      }
      .status.active {
        background: #dcfce7;
        color: #166534;
      }
      .status.inactive {
        background: #fee2e2;
        color: #991b1b;
      }
      pre {
        white-space: pre-wrap;
        word-break: break-word;
        background: #0f172a;
        color: #e2e8f0;
        padding: 12px;
        border-radius: 8px;
        font-size: 13px;
        max-height: 180px;
        overflow: auto;
      }

      .result-card {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 12px 14px;
        font-size: 13px;
        color: #0f172a;
      }
      .result-meta {
        display: grid;
        gap: 4px;
        margin-bottom: 12px;
      }
      .result-table-wrapper {
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
      }
      .result-table {
        width: 100%;
        border-collapse: collapse;
      }
      .result-table th,
      .result-table td {
        padding: 8px 10px;
        border-bottom: 1px solid #e2e8f0;
        text-align: left;
      }
      .result-table th {
        background: #e2e8f0;
        font-size: 12px;
        text-transform: none;
        letter-spacing: normal;
      }
      .result-empty {
        font-size: 12px;
        color: #64748b;
        font-style: italic;
      }
      .result-footnote {
        margin-top: 10px;
        font-size: 12px;
        color: #475569;
      }
      .message {
        padding: 12px 16px;
        border-radius: 8px;
        margin-top: 12px;
        display: none;
      }
      .message.success {
        background: #dcfce7;
        color: #166534;
        display: block;
      }
      .message.error {
        background: #fee2e2;
        color: #991b1b;
        display: block;
      }
      .actions button {
        margin-top: 4px;
        width: 100%;
      }
      @media (max-width: 768px) {
        table,
        thead,
        tbody,
        th,
        td,
        tr {
          display: block;
        }
        th {
          position: sticky;
          top: 0;
        }
        tr {
          margin-bottom: 16px;
          background: #fff;
          border-radius: 12px;
          padding: 12px;
          box-shadow: 0 4px 10px rgba(15, 23, 42, 0.06);
        }
        td {
          border: none;
          padding: 8px 0;
        }
        td::before {
          content: attr(data-label);
          font-weight: 600;
          display: block;
          margin-bottom: 4px;
          color: #475569;
        }
        .actions button {
          width: auto;
          margin-right: 6px;
        }
      }
    </style>
  </head>
  <body>
    <h1>Central de Regras NLQ</h1>
    <div class="card">
      <h2>1. Autenticação</h2>
      <label for="token">Token JWT</label>
      <input
        id="token"
        type="text"
        placeholder="cole aqui o token gerado pelo /auth/login"
      />
      <div class="row">
        <div>
          <label for="companyId">Empresa (opcional)</label>
          <input
            id="companyId"
            type="text"
            placeholder="usa a empresa do token se vazio"
          />
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="loadRules">Carregar regras</button>
        </div>
      </div>
      <div id="authMessage" class="message"></div>
    </div>

    <div class="card">
      <h2>2. Criar nova regra</h2>
      <form id="createForm">
        <div class="row">
          <div>
            <label for="ruleName">Nome</label>
            <input id="ruleName" type="text" required />
          </div>
          <div>
            <label for="ruleType">Tipo</label>
            <select id="ruleType">
              <option value="schedule_report">Relatório agendado</option>
              <option value="threshold_alert">Alerta contínuo</option>
            </select>
          </div>
          <div>
            <label for="activateToggle">Ativar imediatamente?</label>
            <select id="activateToggle">
              <option value="yes">Sim</option>
              <option value="no" selected>Não</option>
            </select>
          </div>
        </div>

        <label for="rulePrompt">Prompt (texto em linguagem natural)</label>
        <textarea
          id="rulePrompt"
          placeholder="Ex.: Top 10 dispositivos por consumo no último dia"
        ></textarea>
<button type="submit">Salvar regra</button>
      </form>
      <div id="createMessage" class="message"></div>
    </div>

    <div class="card">
      <h2>3. Regras cadastradas</h2>
      <div id="rulesMessage" class="message"></div>
      <div class="table-wrapper">
        <table id="rulesTable">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Tipo</th>
              <th>Status</th>
              <th>Cron / Última execução</th>
              <th>Prompt</th>
              <th>Último resultado</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    
<script>
      const tokenInput = document.getElementById('token');
      const companyInput = document.getElementById('companyId');
      const loadBtn = document.getElementById('loadRules');
      const authMessage = document.getElementById('authMessage');
      const createForm = document.getElementById('createForm');
      const createMessage = document.getElementById('createMessage');
      const rulesMessage = document.getElementById('rulesMessage');
      const rulesTableBody = document.querySelector('#rulesTable tbody');
      const typeSelect = document.getElementById('ruleType');
      const scheduleHint = document.getElementById('scheduleHint');

      let cachedRules = [];

      function escapeHtml(value) {
        if (value === null || value === undefined) {
          return '';
        }
        return String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function formatDateTime(value) {
        if (!value) {
          return '-';
        }
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return value;
        }
        return date.toLocaleString('pt-BR');
      }

      function formatCellValue(value) {
        if (value === null || value === undefined || value === '') {
          return '-';
        }
        if (typeof value === 'number') {
          return escapeHtml(value.toLocaleString('pt-BR', { maximumFractionDigits: 6 }));
        }
        if (typeof value === 'object') {
          try {
            return escapeHtml(JSON.stringify(value));
          } catch (err) {
            return escapeHtml(String(value));
          }
        }
        return escapeHtml(String(value));
      }

      function renderRowsTable(rows) {
        if (!Array.isArray(rows) || rows.length === 0) {
          return '<div class="result-empty">Nenhum dado retornado.</div>';
        }

        const columns = Array.from(
          rows.reduce((set, row) => {
            Object.keys(row || {}).forEach((key) => set.add(key));
            return set;
          }, new Set())
        );

        if (columns.length === 0) {
          return '<div class="result-empty">Nenhum dado retornado.</div>';
        }

        const headerHtml = columns.map((col) => `<th>${escapeHtml(col)}</th>`).join('');
        const bodyHtml = rows
          .map((row) => {
            const cells = columns
              .map((col) => `<td>${formatCellValue(row?.[col])}</td>`)
              .join('');
            return `<tr>${cells}</tr>`;
          })
          .join('');

        return `
          <div class="result-table-wrapper">
            <table class="result-table">
              <thead><tr>${headerHtml}</tr></thead>
              <tbody>${bodyHtml}</tbody>
            </table>
          </div>
        `;
      }

      function renderLastResult(result) {
        if (!result) {
          return '-';
        }

        if (result.type === 'rule.report') {
          const generatedAt = formatDateTime(result.generatedAt);
          const rowsTable = renderRowsTable(result.rows);
          const rowCount = Array.isArray(result.rows) ? result.rows.length : 0;
          const scheduleSummary = result.metadata?.scheduleSummary
            ? `<div class="result-footnote">${escapeHtml(result.metadata.scheduleSummary)}</div>`
            : '';

          return `
            <div class="result-card">
              <div class="result-meta">
                <div><strong>Regra:</strong> ${escapeHtml(result.name || '-')}</div>
                <div><strong>Empresa:</strong> ${escapeHtml(result.companyId || '-')}</div>
                <div><strong>Gerado em:</strong> ${escapeHtml(generatedAt)}</div>
                <div><strong>Linhas retornadas:</strong> ${rowCount}</div>
              </div>
              ${rowsTable}
              ${scheduleSummary}
            </div>
          `;
        }

        return `<pre>${escapeHtml(JSON.stringify(result, null, 2))}</pre>`;
      }

      function setMessage(el, message, type = 'success') {
        if (!message) {
          el.style.display = 'none';
          el.textContent = '';
          el.className = 'message';
          return;
        }
        el.textContent = message;
        el.className = `message ${type}`;
      }

      function getAuthHeaders() {
        const token = tokenInput.value.trim();
        if (!token) {
          throw new Error('Informe o token JWT.');
        }
        return {
          Authorization: `Bearer ${token}`
        };
      }

   async function fetchJson(url, options = {}) {
  const opts = { ...options };
  const headers = new Headers(opts.headers || {});

  if (opts.body && !headers.has('Content-Type')) {
    headers.set('Content-Type', 'application/json');
  }
  opts.headers = headers;

  const res = await fetch(url, opts);
  if (!res.ok) {
    const text = await res.text();
    throw new Error(text || res.statusText);
  }
  if (res.status === 204) return null;
  return res.json();
}


      function renderRules(list) {
        cachedRules = list;
        rulesTableBody.innerHTML = '';
        if (!Array.isArray(list) || list.length === 0) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 7;
          cell.textContent = 'Nenhuma regra cadastrada ainda.';
          cell.style.textAlign = 'center';
          row.appendChild(cell);
          rulesTableBody.appendChild(row);
          return;
        }

        for (const rule of list) {
          const tr = document.createElement('tr');
          const scheduleSummary = rule.scheduleSummary || rule.metadata?.scheduleSummary || '';
          tr.innerHTML = `
          <td data-label="Nome">
            <strong>${rule.name}</strong><br />
            <small>${rule.companyId}</small>
          </td>
          <td data-label="Tipo">${rule.type}</td>
          <td data-label="Status"><span class="status ${rule.status}">${rule.status}</span></td>
          <td data-label="Agendamento">
            ${rule.scheduleCron || '-'}<br />
            <small>${scheduleSummary}</small><br />
            <small>last run: ${rule.lastRunAt || '-'}</small>
          </td>
          <td data-label="Prompt"><pre>${rule.prompt || ''}</pre></td>
          <td data-label="Resultado">
            ${renderLastResult(rule.lastResult)}
          </td>
          <td data-label="A��es" class="actions"></td>
        `;

          const actionsCell = tr.querySelector('.actions');
          const activateBtn = document.createElement('button');
          activateBtn.textContent = rule.status === 'active' ? 'Desativar' : 'Ativar';
          activateBtn.className = rule.status === 'active' ? 'secondary' : '';
          activateBtn.addEventListener('click', () => toggleRule(rule));

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Excluir';
          deleteBtn.className = 'danger';
          deleteBtn.addEventListener('click', () => deleteRule(rule));

          actionsCell.appendChild(activateBtn);
          actionsCell.appendChild(deleteBtn);
          rulesTableBody.appendChild(tr);
        }
      }

      async function loadRules() {
        setMessage(authMessage);
        setMessage(rulesMessage);
        try {
          const headers = getAuthHeaders();
          const companyId = companyInput.value.trim();
          const query = new URLSearchParams();
          if (companyId) query.set('companyId', companyId);
          const data = await fetchJson(`/rules?${query.toString()}`, { headers });
          renderRules(data?.items ?? []);
          setMessage(authMessage, 'Regras carregadas com sucesso!', 'success');
        } catch (err) {
          setMessage(authMessage, err.message, 'error');
        }
      }

      async function toggleRule(rule) {
        try {
          const headers = getAuthHeaders();
          const endpoint = rule.status === 'active' ? 'deactivate' : 'activate';
          await fetchJson(`/rules/${rule.id}/${endpoint}`, {
            method: 'POST',
            headers
          });
          await loadRules();
        } catch (err) {
          setMessage(rulesMessage, err.message, 'error');
        }
      }

      async function deleteRule(rule) {
        if (!confirm(`Excluir a regra "${rule.name}"?`)) return;
        try {
          const headers = getAuthHeaders();
          await fetchJson(`/rules/${rule.id}`, { method: 'DELETE', headers });
          await loadRules();
        } catch (err) {
          setMessage(rulesMessage, err.message, 'error');
        }
      }

      createForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        setMessage(createMessage);
        try {
          const headers = getAuthHeaders();
          const name = document.getElementById('ruleName').value.trim();
          const type = typeSelect.value;
          const prompt = document.getElementById('rulePrompt').value.trim();
          const activate = document.getElementById('activateToggle').value === 'yes';
          const bodyCompanyId = companyInput.value.trim() || undefined;

          const payload = {
            name,
            type,
            prompt,
            activate,
            companyId: bodyCompanyId
          };

          await fetchJson('/rules', {
            method: 'POST',
            headers,
            body: JSON.stringify(payload)
          });

          setMessage(createMessage, 'Regra criada com sucesso!', 'success');
          createForm.reset();
          typeSelect.dispatchEvent(new Event('change'));
          await loadRules();
        } catch (err) {
          setMessage(createMessage, err.message, 'error');
        }
      });

      loadBtn.addEventListener('click', () => {
        loadRules();
      });

      typeSelect.addEventListener('change', () => {
        const value = typeSelect.value;
        scheduleHint.style.display = value === 'schedule_report' ? 'block' : 'none';
      });

      typeSelect.dispatchEvent(new Event('change'));
    </script></script>
  </body>
</html>
